<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Upload File</title>
</head>
<body>
<h1>Upload File</h1>
<input type="file" id="fileInput" multiple required>
<button id="uploadButton">Upload</button>
<div id="status"></div>
<script>
  fetch('/api/files', {
    headers: { 'Authorization': localStorage.getItem('token') }})
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.error || 'Unknown error');
            });
        }
        return response.json();
    })
    .catch(error => {
        if (error.message === 'Invalid token, please log in again') {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            alert('Błędny token, zaloguj się ponownie');
            window.location.href = '/index.html';
        }
    });
  const username = localStorage.getItem('username');
  window.onload = function() {
    document.getElementById('uploadButton').addEventListener('click', function() {
      const files = document.getElementById("fileInput").files;
      if (files.length === 0) {
        console.error("No files selected.");
        document.getElementById("status").innerText = "No files selected.";
        return;
      }

      Array.from(files).forEach(file => {
        uploadFile(file);
      });
    });

    function uploadFile(file) {
      let formData = new FormData();
      formData.append('file', file);
      formData.append('username', username);

      fetch('/upload', {
        method: 'POST',
        body: formData
      })
              .then(response => {
                if (!response.ok) {
                  throw new Error(`Server upload failed with status: ${response.status}`);
                }
                return response.text();
              })
              .then(result => {
                document.getElementById("status").innerText = "File uploaded successfully.";
              })
              .catch(error => {
                console.error("Error uploading file:", error.message);
                document.getElementById("status").innerText = `Error uploading file: ${error.message}`;
              });
    }
  }
</script>
</body>
</html>
