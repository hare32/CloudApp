<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>File List</title>
  <style>
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    th, td {
      padding: 5px;
      text-align: left;
    }
  </style>
</head>
<body>
<h1>List of Files</h1>
<table id="fileList">
  <tr>
    <th>#</th>
    <th>File Name</th>
    <th>Download</th>
  </tr>
</table>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const fileListElement = document.getElementById('fileList');
    const username = localStorage.getItem('username');
    const storageAccountName = "cloudapp123";
    const containerName = "aplikacja";
    const sasToken = "sp=racwdli&st=2023-12-14T21:08:15Z&se=2024-12-15T05:08:15Z&sv=2022-11-02&sr=c&sig=e3bXOrlqyuyxMpYN6Dm%2BVfSYyvw5rtjb3ZOJ71aNGvY%3D";

    fetch(`https://${storageAccountName}.blob.core.windows.net/${containerName}?restype=container&comp=list&prefix=${username}&${sasToken}`)
            .then(response => response.text())
            .then(str => new window.DOMParser().parseFromString(str, "text/xml"))
            .then(data => {
              const files = data.querySelectorAll('Blob');
              let fileNumber = 1;
              files.forEach(file => {
                const name = file.querySelector('Name').textContent;
                const fileName = name.split('/').pop();

                const row = fileListElement.insertRow();
                const cell1 = row.insertCell(0);
                const cell2 = row.insertCell(1);
                const cell3 = row.insertCell(2);

                cell1.innerHTML = fileNumber++;
                cell2.innerHTML = fileName;

                const downloadButton = document.createElement('button');
                downloadButton.textContent = 'Download';
                downloadButton.onclick = async () => {
                  // Download logic
                  try {
                    const response = await fetch(`https://${storageAccountName}.blob.core.windows.net/${containerName}/${name}?${sasToken}`);
                    if (!response.ok) {
                      throw new Error(`Download failed with status: ${response.status}`);
                    }
                    const blob = await response.blob();
                    const downloadLink = document.createElement('a');
                    downloadLink.href = window.URL.createObjectURL(blob);
                    downloadLink.download = fileName;
                    downloadLink.click();
                  } catch (error) {
                    console.error('Download failed:', error);
                  }
                };

                cell3.appendChild(downloadButton);
              });
            })
            .catch(error => console.error('Error fetching files:', error));
  });
</script>
</body>
</html>
